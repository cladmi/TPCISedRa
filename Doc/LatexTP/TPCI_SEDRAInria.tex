%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Programming/Coding Assignment
% LaTeX Template
%
% This template has been downloaded from:
% http://www.latextemplates.com
%
% Original author:
% Ted Pavlic (http://www.tedpavlic.com)
%
% Note:
% The \lipsum[#] commands throughout this template generate dummy text
% to fill the template out. These commands should all be removed when
% writing assignment content.
%
% This template uses a Perl script as an example snippet of code, most other
% languages are also usable. Configure them in the "CODE INCLUSION
% CONFIGURATION" section.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%----------------------------------------------------------------------------------------
%	PACKAGES AND OTHER DOCUMENT CONFIGURATIONS
%----------------------------------------------------------------------------------------

\documentclass{article}

\usepackage{fancyhdr} % Required for custom headers
\usepackage{lastpage} % Required to determine the last page for the footer
\usepackage{extramarks} % Required for headers and footers
\usepackage[usenames,dvipsnames]{color} % Required for custom colors
\usepackage{graphicx} % Required to insert images
\usepackage{listings} % Required for insertion of code
\usepackage{courier} % Required for the courier font
\usepackage{lipsum} % Used for inserting dummy 'Lorem ipsum' text into the template
\usepackage{hyperref} % For urls
\usepackage{dirtree}

% Margins
\topmargin=-0.45in
\evensidemargin=0in
\oddsidemargin=0in
\textwidth=6.5in
\textheight=9.0in
\headsep=0.25in

\linespread{1.1} % Line spacing

% Set up the header and footer
\pagestyle{fancy}
%\lhead{\hmwkAuthorName} % Top left header
%\chead{\hmwkClass\ (\hmwkClassInstructor\ \hmwkClassTime): \hmwkTitle} % Top center head
\lhead{\hmwkTitle} % Top center head
\rhead{\firstxmark} % Top right header
\lfoot{\lastxmark} % Bottom left footer
\cfoot{} % Bottom center footer
\rfoot{Page\ \thepage\ of\ \protect\pageref{LastPage}} % Bottom right footer
\renewcommand\headrulewidth{0.4pt} % Size of the header rule
\renewcommand\footrulewidth{0.4pt} % Size of the footer rule

\setlength\parindent{0pt} % Removes all indentation from paragraphs

%----------------------------------------------------------------------------------------
%	CODE INCLUSION CONFIGURATION
%----------------------------------------------------------------------------------------

\definecolor{MyDarkGreen}{rgb}{0.0,0.4,0.0} % This is the color used for comments
\lstloadlanguages{Perl, Java, Python, C++} % Load Perl syntax for listings, for a list of other languages supported see: ftp://ftp.tex.ac.uk/tex-archive/macros/latex/contrib/listings/listings.pdf

\lstset{language=C++, % Use C++
        frame=single, % Single frame around code
        basicstyle=\small\ttfamily, % Use small true type font
        keywordstyle=[1]\color{Blue}\bf, % functions bold and blue
        keywordstyle=[2]\color{Purple}, % function arguments purple
        keywordstyle=[3]\color{Blue}\underbar, % Custom functions underlined and blue
        identifierstyle=, % Nothing special about identifiers
        commentstyle=\usefont{T1}{pcr}{m}{sl}\color{MyDarkGreen}\small, % Comments small dark green courier font
        stringstyle=\color{Purple}, % Strings are purple
        showstringspaces=false, % Don't put marks in string spaces
        tabsize=4, % 5 spaces per tab
       	%
        morecomment=[l][\color{Blue}]{...}, % Line continuation (...) like blue comment
        numbers=left, % Line numbers on left
        firstnumber=1, % Line numbers start with line 1
        numberstyle=\tiny\color{Blue}, % Line numbers are blue and small
        stepnumber=2 % Line numbers go in steps of 5
}
\lstset{language=Java, % Use Java in this example
        frame=single, % Single frame around code
        basicstyle=\small\ttfamily, % Use small true type font
        keywordstyle=[1]\color{Blue}\bf, % functions bold and blue
        keywordstyle=[2]\color{Purple}, %  function arguments purple
        keywordstyle=[3]\color{Blue}\underbar, % Custom functions underlined and blue
        identifierstyle=, % Nothing special about identifiers
        commentstyle=\usefont{T1}{pcr}{m}{sl}\color{MyDarkGreen}\small, % Comments small dark green courier font
        stringstyle=\color{Purple}, % Strings are purple
        showstringspaces=false, % Don't put marks in string spaces
        tabsize=4, % 5 spaces per tab
       	%
        morecomment=[l][\color{Blue}]{...}, % Line continuation (...) like blue comment
        numbers=left, % Line numbers on left
        firstnumber=1, % Line numbers start with line 1
        numberstyle=\tiny\color{Blue}, % Line numbers are blue and small
        stepnumber=2 % Line numbers go in steps of 5
}
\lstset{language=Python, % Use Python in this example
        frame=single, % Single frame around code
        basicstyle=\small\ttfamily, % Use small true type font
        keywordstyle=[1]\color{Blue}\bf, % functions bold and blue
        keywordstyle=[2]\color{Purple}, % function arguments purple
        keywordstyle=[3]\color{Blue}\underbar, % Custom functions underlined and blue
        identifierstyle=, % Nothing special about identifiers
        commentstyle=\usefont{T1}{pcr}{m}{sl}\color{MyDarkGreen}\small, % Comments small dark green courier font
        stringstyle=\color{Purple}, % Strings are purple
        showstringspaces=false, % Don't put marks in string spaces
        tabsize=4, % 5 spaces per tab
       	%
        morecomment=[l][\color{Blue}]{...}, % Line continuation (...) like blue comment
        numbers=left, % Line numbers on left
        firstnumber=1, % Line numbers start with line 1
        numberstyle=\tiny\color{Blue}, % Line numbers are blue and small
        stepnumber=2 % Line numbers go in steps of 2
}

\lstset{language=Perl, % Use Perl in this example
        frame=single, % Single frame around code
        basicstyle=\small\ttfamily, % Use small true type font
        keywordstyle=[1]\color{Blue}\bf, % Perl functions bold and blue
        keywordstyle=[2]\color{Purple}, % Perl function arguments purple
        keywordstyle=[3]\color{Blue}\underbar, % Custom functions underlined and blue
        identifierstyle=, % Nothing special about identifiers
        commentstyle=\usefont{T1}{pcr}{m}{sl}\color{MyDarkGreen}\small, % Comments small dark green courier font
        stringstyle=\color{Purple}, % Strings are purple
        showstringspaces=false, % Don't put marks in string spaces
        tabsize=5, % 5 spaces per tab
        %
        % Put standard Perl functions not included in the default language here
        morekeywords={rand},
        %
        % Put Perl function parameters here
        morekeywords=[2]{on, off, interp},
        %
        % Put user defined functions here
        morekeywords=[3]{test},
       	%
        morecomment=[l][\color{Blue}]{...}, % Line continuation (...) like blue comment
        numbers=left, % Line numbers on left
        firstnumber=1, % Line numbers start with line 1
        numberstyle=\tiny\color{Blue}, % Line numbers are blue and small
        stepnumber=5 % Line numbers go in steps of 5
}

% Creates a new command to include a perl script, the first parameter is the filename of the script (without .pl), the second parameter is the caption
\newcommand{\perlscript}[2]{
\begin{itemize}
\item[]\lstinputlisting[caption=#2,label=#1]{#1.pl}
\end{itemize}
}

\newcommand{\javascript}[2]{
\begin{itemize}
\item[]\lstinputlisting[caption=#2,label=#1]{#1.java}
\end{itemize}
}

\newcommand{\pythonscript}[2]{
\begin{itemize}
\item[]\lstinputlisting[caption=#2,label=#1]{#1.py}
\end{itemize}
}

\newcommand{\cppscript}[2]{
\begin{itemize}
\item[]\lstinputlisting[caption=#2,label=#1]{#1.cpp}
\end{itemize}
}

%----------------------------------------------------------------------------------------
%	DOCUMENT STRUCTURE COMMANDS
%	Skip this unless you know what you're doing
%----------------------------------------------------------------------------------------

% Header and footer for when a page split occurs within a problem environment
\newcommand{\enterProblemHeader}[1]{
\nobreak\extramarks{#1}{#1 continued on next page\ldots}\nobreak
\nobreak\extramarks{#1 (continued)}{#1 continued on next page\ldots}\nobreak
}

% Header and footer for when a page split occurs between problem environments
\newcommand{\exitProblemHeader}[1]{
\nobreak\extramarks{#1 (continued)}{#1 continued on next page\ldots}\nobreak
\nobreak\extramarks{#1}{}\nobreak
}

\setcounter{secnumdepth}{0} % Removes default section numbers
\newcounter{homeworkProblemCounter} % Creates a counter to keep track of the number of problems

\newcommand{\homeworkProblemName}{}
\newenvironment{homeworkProblem}[1][Problem \arabic{homeworkProblemCounter}]{ % Makes a new environment called homeworkProblem which takes 1 argument (custom name) but the default is "Problem #"
\stepcounter{homeworkProblemCounter} % Increase counter for number of problems
\renewcommand{\homeworkProblemName}{#1} % Assign \homeworkProblemName the name of the problem
\section{\homeworkProblemName} % Make a section in the document with the custom problem count
\enterProblemHeader{\homeworkProblemName} % Header and footer within the environment
}{
\exitProblemHeader{\homeworkProblemName} % Header and footer after the environment
}

\newcommand{\problemAnswer}[1]{ % Defines the problem answer command with the content as the only argument
\noindent\framebox[\columnwidth][c]{\begin{minipage}{0.98\columnwidth}#1\end{minipage}} % Makes the box around the problem answer and puts the content inside
}

\newcommand{\homeworkSectionName}{}
\newenvironment{homeworkSection}[1]{ % New environment for sections within homework problems, takes 1 argument - the name of the section
\renewcommand{\homeworkSectionName}{#1} % Assign \homeworkSectionName to the name of the section from the environment argument
\subsection{\homeworkSectionName} % Make a subsection with the custom name of the subsection
\enterProblemHeader{\homeworkProblemName\ [\homeworkSectionName]} % Header and footer within the environment
}{
\enterProblemHeader{\homeworkProblemName} % Header and footer after the environment
}

%----------------------------------------------------------------------------------------
%	NAME AND CLASS SECTION
%----------------------------------------------------------------------------------------

\newcommand{\hmwkTitle}{Java/C++/Python Exercices} % Assignment title
\newcommand{\hmwkDueDate}{Thursday,\ October\ 29,\ 2015} % Due date
\newcommand{\hmwkClass}{Continuous Integration Seminar} % Course/class
\newcommand{\hmwkClassTime}{13h30} % Class/lecture time
\newcommand{\hmwkClassInstructor}{} % Teacher/lecturer
\newcommand{\hmwkAuthorName}{Maurice Bremond, Gaetan Harter, David Parsons -- SED INRIA Rhône-Alpes} % Your name


%----------------------------------------------------------------------------------------
%	TITLE PAGE
%----------------------------------------------------------------------------------------

\title{
%\vspace{2in}
\textsc{\hmwkClass}\\
\textbf{\hmwkTitle}\\
%\normalsize\vspace{0.1in}\small{\hmwkDueDate}\\
%\vspace{0.1in}\large{\textit{\hmwkClassInstructor\ \hmwkClassTime}}
%\vspace{3in}
}

\author{\textsf{\hmwkAuthorName}}
\date{\textit{\hmwkDueDate}} % Insert date here if you want it to appear below your name

%----------------------------------------------------------------------------------------

\begin{document}

\maketitle

%----------------------------------------------------------------------------------------
%	TABLE OF CONTENTS
%----------------------------------------------------------------------------------------

%\setcounter{tocdepth}{1} % Uncomment this line if you don't want subsections listed in the ToC

%\newpage
\tableofcontents
%\newpage


%----------------------------------------------------------------------------------------
%	JAVA
%----------------------------------------------------------------------------------------

% To have just one problem per page, simply put a \clearpage after each problem
\begin{homeworkProblem}[Java Exercice]

\section{Local Test Part}

\subsection{Preamble}

To go through this exercise, you will need to install
\begin{itemize}
\item Git (apt-get install git | yum install git)
\item A JDK (apt-get install openjdk-7-jdk | yum install java-1.7.0-openjdk)
\item Maven (apt-get install maven | yum install apache-maven)
\end{itemize}

You will also need an account on both gforge.inria.fr and ci.inria.fr and be a member of the tpcisedra project.

\subsection{Setup}

\subsubsection{Create a personal copy of the git repository from INRIA forge and clone it}
Go to https~://gforge.inria.fr/projects/tpcisedra/ \\
Click on the ``SOURCE CODE'' tab \\
Click on ``create a personal repository'' \\
Back to the ``SOURCE CODE'' tab, look for the command to access your personal repository. \\
WARNING~: do not use the anonymous access (containing ``anonscm'') \\
The correct command should look like this~:
\begin{lstlisting}
$ git clone git+ssh://<yourloginhere>@scm.gforge.inria.fr/gitroot/tpcisedra/
    users/<yourloginhere>.git
$ cd <yourloginhere>/java
\end{lstlisting}

\
You should have retrieved the following file tree~:\\
{\centering\small
            \begin{minipage}[t]{0.3\linewidth}
\dirtree{%
.1 tpcisedra/java.
.2 pom.xml.
.2 src.
.3 main.
.4 java.
.5 fr.
.6 inria.
.7 sed.
.8 Sphere.java.
.3 tst.
.4 java.
.5 fr.
.6 inria.
.7 sed.
.8 SphereTest.java.
}
\end{minipage}
}


The project is made up of~:
\begin{itemize}
\item A Maven ``Project Object Model'' file named \texttt{pom.xml};
\item A file \texttt{Sphere.java} implementing the class \texttt{Sphere};
\item A file \texttt{SphereTest.java} implementing its test class \texttt{SphereTest}.
\end{itemize}

\subsubsection{Check that you can build the project}
\begin{lstlisting}
$ pwd
yourpath/tpcisedra/java
$ mvn package
\end{lstlisting}

You should see these lines (among others)~:
\begin{lstlisting}
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
\end{lstlisting}



%--------------------------------------
\subsection{Testing your code}

\subsubsection{Run the (single) test}
\begin{lstlisting}
$ mvn test
\end{lstlisting}

You should see something like
\begin{lstlisting}
-------------------------------------------------------
 T E S T S
-------------------------------------------------------
Running fr.inria.sed.SphereTest
Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.069 sec

Results :

Tests run: 1, Failures: 0, Errors: 0, Skipped: 0

[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
\end{lstlisting}

\subsubsection{Exercice 1}

Have a look at the code of the method \texttt{Sphere::computeVolume()}.\\
To do so, edit \texttt{tpcisedra/java/src/main/java/fr/inria/sed/Sphere.java}.

The code should be like that~:
\begin{lstlisting}
public double computeVolume1() {
  return 4 * Math.PI * Math.pow(radius_, 3) / 3;
}
\end{lstlisting}


We might want the value~: \verb?4 * Math.PI / 3? to be computed once and for all.

TODO~:
\begin{itemize}
\item Extract this value into a class data member
\item Run the test again. It should fail.
\end{itemize}

Here is the output you should get~:
\begin{lstlisting}
-------------------------------------------------------
 T E S T S
-------------------------------------------------------
Running fr.inria.sed.SphereTest
Tests run: 1, Failures: 1, Errors: 0, Skipped: 0, Time elapsed: 0.076 sec <<< FAILURE!

Results :

Failed tests:   testComputeVolume(fr.inria.sed.SphereTest):
    expected:<14.137166941154069> but was:<14.137166941154067>

Tests run: 1, Failures: 1, Errors: 0, Skipped: 0

[INFO] ------------------------------------------------------------------------
[INFO] BUILD FAILURE
[INFO] ------------------------------------------------------------------------
\end{lstlisting}

\subsubsection{Exercice 2}

Why does the test in \texttt{SphereTest.java} fail ?

This is because of floating point arithmetics \emph{rounding errors}.

Our response to this issue strongly depends on what kind of application we are working on~:
\begin{itemize}
\item In some cases, we want to be aware that something has changed, even when the change is the tiniest. In that case, the test we already have is just what we want.
\item In other cases, we need not worry about such a small difference and hence do not want to be bothered by tests complaining.
\end{itemize}

TODO~:
\begin{itemize}
\item Find a way to modify the appropriate test in \texttt{SphereTest.java}
so small rounding differences do not cause errors.
\end{itemize}


%--------------------------------------
\subsection{Test Coverage}

At this stage, all our tests pass. But what does that mean regarding our application ?

Not much you may say, but can you quantify it and will you be able to tell on a real project ?

This is when \textbf{test coverage} becomes handy.

\subsubsection{Run test coverage}

Run the following \texttt{maven} command~:
\begin{lstlisting}
$ pwd
yourpath/tpcisedra/java
$ mvn cobertura:cobertura
\end{lstlisting}

Cobertura should have produced test coverage results in the following directory~:\\
\texttt{yourpath/tpcisedra/java/target/site/cobertura}


Use your favorite WEB browser (firefox, chrome, iceweasel, \...) to visualize the generated results of the test coverage
\begin{lstlisting}
$ firefox target/site/cobertura/index.html &
\end{lstlisting}

\subsubsection{Exercice 3}

\begin{itemize}
\item Populate your tests to achieve 100\% test coverage.\\
Hint~: you may not need any additional tests ;)
\end{itemize}


\subsubsection{[Optional] Integrate cobertura to your reporting local website}

Add the following to the file  \texttt{pom.xml}
\begin{lstlisting}
  <reporting>
    <plugins>
      <plugin>
        <groupId>org.codehaus.mojo</groupId>
        <artifactId>cobertura-maven-plugin</artifactId>
        <version>2.7</version>
      </plugin>
    </plugins>
  </reporting>
\end{lstlisting}

The report generation is now included in the build lifecycle (``site'' phase).

\subsubsection{Exercice 3bis}

\begin{itemize}
\item To generate the report~:
\begin{lstlisting}
$ pwd
yourpath/tpcisedra/java
$ mvn site
\end{lstlisting}

\item Use your favorite WEB browser (firefox, chrome, iceweasel, \...) to visualize the generated report~:
\begin{lstlisting}
iceweasel target/site/project-reports.html &
\end{lstlisting}
\end{itemize}

\subsubsection{Add some new class to our project}

Let's add a new class \texttt{Alphabet} and its test class \texttt{AlphabetTest} to our project
\begin{lstlisting}
$ git merge alpha
\end{lstlisting}


\subsubsection{Exercice 4}
\begin{itemize}
\item Generate and visualize the corresponding coverage report
\item Make what changes are necessary to achieve 100\% test coverage
\end{itemize}

%--------------------------------------
\subsection{Stylecheck}

\subsubsection{Run a style checker}

Let's try and run a style checker~:
\begin{lstlisting}
$ pwd
yourpath/tpcisedra/java
$ mvn checkstyle:checkstyle
\end{lstlisting}
We get plenty of errors with the default style \verb?sun_checks.xml?.

Our coding style is close to Google style than it is to Sun style.

\subsubsection{Run Google style checker}

Try running with Google checks (provided by the plugin)
\begin{lstlisting}
$ pwd
yourpath/tpcisedra/java
$ mvn checkstyle:checkstyle -Dcheckstyle.config.location=google_checks.xml
\end{lstlisting}
NOTE~: this can also be achieved by adding the following lines to your pom.xml~:
\begin{lstlisting}
  <properties>
    <checkstyle.config.location>checkstyle-test.xml</checkstyle.config.location>
  </properties>
\end{lstlisting}

It's getting better but we might want to make a few changes to this default behaviour.

\subsubsection{Exercice 5}

\begin{itemize}
\item Retrieve a local copy of google checks
\begin{lstlisting}
$ wget https://raw.githubusercontent.com/checkstyle/checkstyle/
     18f6ebbcad23e88e3ae30fc79be464b8b7772a0d/google_checks.xml
\end{lstlisting}
\item  Modify the file \texttt{google\_checks.xml} so that it accepts single character
parameter names.
\item You may also consider removing trailing underscores from data members or amending checkstyle.xml
\end{itemize}

\subsubsection{[Optional] Integrate checkstyle to your reporting local website}

Add the following to the file \texttt{pom.xml}
\begin{lstlisting}
  <reporting>
    <plugins>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-checkstyle-plugin</artifactId>
        <version>2.16</version>
      </plugin>
    </plugins>
  </reporting>
\end{lstlisting}

The check style report is now included in the build lifecycle (``site'' phase).

\subsubsection{Exercice 5bis}

\begin {itemize}
\item To generate the report~:
\begin{lstlisting}
$ pwd
yourpath/tpcisedra/java
$ mvn site
\end{lstlisting}
\item Use your favorite WEB browser (firefox, chrome, iceweasel, \...) to visualize the generated report~:
\begin{lstlisting}
$ firefox target/site/project-reports.html &
\end{lstlisting}
\end{itemize}



%----------------------------------------------------------------------------------------
%   Java CI
%----------------------------------------------------------------------------------------
\section{Continuous Integration Part}

\subsection{Log into the project's Jenkins instance}
Connect to the INRIA Continuous Integration web portal~: \url{https://ci.inria.fr/} \\
Log in and click ``Dashboard''in the top menu \\
You should have been added to project ``TPCISedRa'', click on the ``Jenkins'' button \\
You may be prompted to log into jenkins, use the same login/passwd as for the ci portal

\subsection{Running your first test on CI}
From our Jenkins dashboard page (\url{https://ci.inria.fr/tpcisedra/}), click ``New Item'' in the menu on the left
Provide a name for this new item (avoid spaces since it is likely to lead to errors) and select ``Maven project''

\subsubsection{Git configuration}
In the new item's configuration page (which you will be redirected to after clicking ``OK''), choose Git as your Source Code Manager and copy the \emph{anonymous} url to your personal repository into the appropriate field~:
\begin{lstlisting}
https://scm.gforge.inria.fr/anonscm/git/tpcisedra/users/dparsons.git
\end{lstlisting}
\end{homeworkProblem}

\subsubsection{Build configuration}
In the ``Build'' section, change the root POM path to \texttt{java/pom.xml} and type \texttt{test} in ``Goals and options''

\subsubsection{Save}

\subsubsection{Run the test}
Click ``Build Now'' in the menu on the left

\subsubsection{Check the output}
In the ``Build History'' on the left, click on the last build (hopefully \#1), then select ``Console Output'' \\
You can also check the ``Test Result''

\subsection{Adding feedback to your build}
One of the good things with Jenkins is its ability to nicely present your test results. \\
The tools we used to run tests and code quality checks have been selected based on the availability of the corresponding Jenkins plugins.

\subsubsection{Add coverage report}
\begin{itemize}
\item Go back to your item's configuration page (use the menu on the left)
\item Replace your build's ``Goals and options'' with \texttt{cobertura:cobertura -Dcobertura.report.format=xml}
\item Click on ``Add post-build action'' and select ``Publish Cobertura Coverage Report'' from the drop-down menu, your ``Cobertura xml report pattern'' is \texttt{**/target/site/cobertura/coverage.xml} (it is the example provided below the field)
\item Save and Run the test
\item Check the output~: in the ``Build History'' on the left, click on the last build, you should have a new entry named ``Coverage Report'', have a look at it
\end{itemize}

\subsubsection{Add checkstyle report}
\begin{itemize}
\item Go back to your item's configuration page and add \\
\texttt{checkstyle:checkstyle -Dcheckstyle.config.location=google\_checks.xml} to your build's ``Goals and options''
\item Check the ``Publish Checkstyle analysis results'' box in ``Build Settings''
\item Save and Run the test
\item Check the output~: in the ``Build History'' on the left, click on the last build, you should have a new entry named ``Checkstyle Warnings'', have a look at it
\end{itemize}

\clearpage



%----------------------------------------------------------------------------------------
%   PYTHON
%----------------------------------------------------------------------------------------
\begin{homeworkProblem}[Python Exercice]

\section{Local Test Part}

\subsection{Preamble}

In this Python exercice, you will learn how to setup a python package with
packaging tools, tests, tests code coverage, and static code analysis.
At the end you will run the project validations in one command, and know how to
setup it on your personnal projects.


\subsubsection{Tools presentation}

In the exercices you will use different tools, each one having its specific
goal.

\texttt{setuptools} packages your project,
\texttt{unittest} to write tests (standard library),
\texttt{nose} tools run tests and format the results,
\texttt{mock} allow replacing function or objects during tests,
\texttt{pylint} provide static code analysis and style checking,
\texttt{pep8} verifies code compliancy to python PEP8 style convention
and \texttt{tox} is a virtualenv based test automation tool which runs all
testing steps.


\subsection{Setup}

\subsubsection{Python requirements}

For the exercices you need to install the following dependencies.

\begin{lstlisting}
sudo aptitude install  python2 python2-pip python2-argparse

# Install directly from Python Package Index
sudo -H pip install --upgrade  nosetests nose-xcover
sudo -H pip install --upgrade  mock
sudo -H pip install --upgrade  pylint pep8 setuptools-lint setuptools-pep8
sudo -H pip install --upgrade  tox
\end{lstlisting}



\textbf{TODO}
install dependencies along the exercises to present them when used.
\textbf{TODO}


\subsubsection{Create and clone your personal copy of the repository}

\textbf{TODO}, copy the java version or put it in a shared section \textbf{TODO}



You should have retrieved the following file tree~:


\textbf{TODO} FileTree with each files described \textbf{TODO}

\subsection{Code overview}

This code is the wonderfull implementation of a package that will calculate the
volume of spheres. And the whole world will want it, so it should be perfect.

It has a package, named \texttt{tp\_ci\_sed}, with a \texttt{sphere} submodule
and even a cli script to run it.

\subsubsection{Exercice 1}

Try the \texttt{sphere} script.

\subsubsection{Exercice 2}

Write the \texttt{Sphere.volume} method.
For that use the \texttt{math} module and remember the volume formula
$ 4 * \Pi * R^3 / 3 $ you learned in school
\footnote{Volume of a $1.5$ radius sphere is around $14.137$}.

\subsubsection{Releasing your code}

After committing your changes, your package is now ready to use by everyone.
But can users install it in this state?


\subsection{Packaging your code}

First step of an integration process is to be able to install your project with
its dependencies. In Python it's done using a \texttt{setup.py} script
written with \texttt{setuptools}
\footnote{Default is \texttt{setup.py} package is \texttt{distutils} but it
does not manage automatic dependency installation}.

The script consist of calling the \texttt{setuptools.setup} function with infos
describing your package\~: name, description, author, license, version,
dependencies, supported python versions, \dots


\subsubsection{Usage}

This \texttt{setup.py} script is the entry point for installing and releasing
your code. It will also be used later as an entry point for tests scripts.

\begin{lstlisting}
python setup.py <command> [opts]

# Install the package
python setup.py install

# Install the package in a way that lets you edit the sources
python setup.py develop

# Upload your last revision to PyPi repository
python setup.py upload
\end{lstlisting}


\paragraph{Setuptools Documentation}
\url{https://pythonhosted.org/setuptools/setuptools.html}


\subsubsection{Writing the \texttt{setup.py} script}

Writing the script is basically just giving the right informations in the right
format. Usually adapting an existing one is simple enough so it is provided in
this exercise.

Copy the \texttt{first} script from the \texttt{raw} folder as \texttt{setup.py}.
\begin{lstlisting}
 cp raw/first setup.py
 cat setup.py
\end{lstlisting}

Open the \texttt{setup.py} script and look at the \texttt{setup} function
arguments.


\paragraph{Package dependency}
Instead of writing in a README what packages are required by your project,
they can be automatically at package installation with \texttt{setuptools}.
Dependencies should be listed in the \texttt{install\_requires} here
\texttt{argparse} will be installed with the package.

\begin{lstlisting}
setup(
    ...,
    install_requires=['argparse'],
)
\end{lstlisting}

Depending on your needs, you can specify the version with \texttt{==, <, !=} operators.

\begin{description}
\item[Note]
By default \texttt{setuptools} uses PyPi to find packages but can be configured
to install from many places, like an existing git repository or an http url
\footnote{\url{https://pythonhosted.org/setuptools/setuptools.html\#dependencies-that-aren-t-in-pypi}}.
\end{description}


\paragraph{Package version} In a python package, version is usually accessible
using \texttt{package\_name.\_\_version\_\_} and should be consistent with the
version in \texttt{setup.py}.

Importing the package in the \texttt{setup.py} script is a source of import
errors and code coverage problems
\footnote{Don't import your package in \texttt{setup.py}
\url{https://stackoverflow.com/q/11279096/395687}}.

To prevent that, the \texttt{\_\_init\_\_.py} file should be read and parsed
manually to find the version.

\paragraph{}
The package version can be queried with:
\begin{lstlisting}
python setup.py --version
\end{lstlisting}


\subsubsection{Exercice 3}

Find where the version is stored and how it is retrieved in the
\texttt{setup.py} script.


\subsubsection{Semantic Versioning}

Versioning should help users follow features addition and know when incompatible
changes have been introduced.
Semantic Versioning
gives you simple rules
to know how to change your version numbers.

\begin{quote}
\begin{center}Summary \url{http://semver.org/}\end{center}

Given a version number MAJOR.MINOR.PATCH, increment the:

\begin{itemize}
	\item MAJOR version when you make incompatible API changes,
	\item MINOR version when you add functionality in a backwards-compatible manner, and
	\item PATCH version when you make backwards-compatible bug fixes.
\end{itemize}
Additional labels for pre-release and build metadata are available as extensions to the MAJOR.MINOR.PATCH format.
\end{quote}

For the following parts, remember to increment the version when you change the
API.


\subsection{Tests}

Testing your code is simply executing it and expecting some result.
Like executing a script it in command line and checking the printed output.

However to some parts of the code may be hard to reach from the cli, and may be
easier to test by calling directly the functions.

But to simplify the organization we will use existing tools to write them.


\paragraph{}In this section you will write tests using \texttt{unittest} and
execute them with \texttt{nosetests}.

One test has already been written as an example. Run it with \texttt{nosetests}
\begin{lstlisting}
nosetests -v
test_volume_0 (tp_ci_sed.test.sphere_test.TestSphere) ... ok

----------------------------------------------------------------------
Ran 1 test in 0.006s

OK
\end{lstlisting}

Now go in \texttt{tp\_ci\_sed/test/sphere\_test.py} to see the implementation.

\paragraph{unittest}
framework\footnote{\url{https://docs.python.org/2/library/unittest.html}}
is the Python implementation of \texttt{JUnit}.

It provides a \texttt{TestCase} base class to help writing tests.
This class implements several assert functions and also runs \texttt{setUp} and
\texttt{tearDown} methods before and after each tests if implemented.
This helps configuring a test environment.


\subsubsection{Exercice 4}

As you can see, \texttt{test\_volume\_0} is not enough to validate your code.
Add another test to validate the volume computation with
$radius=1.5$ where $volume=14.137166941154069$.

\subsubsection{Refactoring}

Now that your code is tested, you can safely start refactoring it.
In our formula, the $ 4 * \Pi / 3 $ part can be computed only once instead of
at each \texttt{volume} call.
Move it in a class variable and use it in the \texttt{volume} method.

\subsubsection{Exercice 5}

Run the tests again. It should fail:

\begin{description}
\item[Note] If it does not fail, ask for help, magic numbers technique failed.
\end{description}

\begin{lstlisting}
nosetests -v
test_volume_0 (tp_ci_sed.test.sphere_test.TestSphere) ... ok
test_volume_1_5 (tp_ci_sed.test.sphere_test.TestSphere) ... FAIL

======================================================================
FAIL: test_volume_1_5 (tp_ci_sed.test.sphere_test.TestSphere)
----------------------------------------------------------------------
Traceback (most recent call last):
  File ".../tp_ci_sed/test/sphere_test.py", line 19, in test_volume_1_5
    self.assertEqual(14.137166941154069, vol)
AssertionError: 14.137166941154069 != 14.137166941154067

----------------------------------------------------------------------
Ran 2 tests in 0.007s

FAILED (failures=1)
\end{lstlisting}

Why does the test fail?

Because of floating point arithmetics \emph{rounding errors}.

Our response to this issue strongly depends on what kind of application we are
working on:
\begin{itemize}
\item In some cases, we want to be aware that something has changed, even when
    the change is the tiniest. In that case, the test we already have is just what we want.
\item In other cases, we need not worry about such a small difference and hence
    do not want to be bothered by tests complaining.
\end{itemize}

TODO:
\begin{itemize}
\item Find a way to modify the test so small rounding differences do not cause errors.

List of \texttt{unittest} assert functions:\\
\url{https://docs.python.org/2/library/unittest.html\#unittest.FunctionTestCase}
\end{itemize}


\subsection{Code coverage}

When running tests, the information of what part of the code has been tested is
also meaningful. It is often refered as "code coverage".

With Python it can be generated with the \texttt{coverage} package, but also
directly with \texttt{nosetests} and \texttt{nose-xcover}.

To get the coverage output, run
\begin{lstlisting}
 nosetests -v --with-xcoverage --cover-erase  --cover-inclusive \
    --cover-branches --cover-html --cover-package  tp_ci_sed

test_volume_0 (tp_ci_sed.test.sphere_test.TestSphere) ... ok
test_volume_1_5 (tp_ci_sed.test.sphere_test.TestSphere) ... ok

Name                  Stmts   Miss Branch BrPart  Cover   Missing
-----------------------------------------------------------------
tp_ci_sed.py              1      0      0      0   100%
tp_ci_sed/sphere.py      19      6      2      1    67%   19, 28-32, 36, 35->36
-----------------------------------------------------------------
TOTAL                    20      6      2      1    68%
----------------------------------------------------------------------
Ran 2 tests in 0.012s

OK
\end{lstlisting}

You can read the coverage output directly in the \texttt{nosetests} output.
But a human readable html report and an xml report for jenkins are also generated.


\begin{lstlisting}
 ls
cover coverage.xml  raw  sphere  tp_ci_sed
 file coverage.xml
coverage.xml: XML document text
\end{lstlisting}

See the html report

\begin{lstlisting}
 firefox cover/index.html &
\end{lstlisting}


\subsection{\texttt{setup.py} subcommands}

As running \texttt{nosetests} with all the options is quite a pain, you will use
\texttt{setuptools} to configure the \texttt{nosetests} command.

Calling \texttt{nosetests} can be done using
\begin{lstlisting}
 python setup.py nosetests

...

reading manifest file 'tp_ci_sed.egg-info/SOURCES.txt'
writing manifest file 'tp_ci_sed.egg-info/SOURCES.txt'
..
----------------------------------------------------------------------
Ran 2 tests in 0.006s

OK
\end{lstlisting}

Configuring \texttt{setup.py} commands requires adding options in a
\texttt{setup.cfg} file.

Copy the \texttt{second} script from the \texttt{raw} folder as \texttt{setup.cfg}.
\begin{lstlisting}
 cp raw/second setup.cfg
 cat setup.cfg
\end{lstlisting}

The first part is \texttt{nosetests} configuration and allow coverage and also
searching for all type of tests.

Re run the command:

\begin{lstlisting}
 python setup.py nosetests

...

----------------------------------------------------------------------
XML: /home/harter/work/tpcisedra/python/nosetests.xml
Name                  Stmts   Miss Branch BrPart  Cover   Missing
-----------------------------------------------------------------
tp_ci_sed.py              1      0      0      0   100%
tp_ci_sed/sphere.py      19      6      2      1    67%   19, 28-32, 36, 35->36
-----------------------------------------------------------------
TOTAL                    20      6      2      1    68%
----------------------------------------------------------------------
Ran 2 tests in 0.012s

OK
\end{lstlisting}


Now running the tests with \texttt{python setup.py nosetests} also generates the
coverage report.


\subsection{Code static analysis and style}

Python is a dynamic language where many things are evaluated dynamically,
more than compiled languages. It means that if you do typos errors may only
occur when running the program. Using a static analysis program can detect
errors without executing your program.

With the same goal, using coding standards for formatting your code can increase
readability. It make all your code look the same and ease readability.
For python there is even an official coding style guide defined in the
Python Enhancement Proposal 8 (PEP8\footnote{\url{https://www.python.org/dev/peps/pep-0008/}}).


\paragraph{}In this section you will use two tools:
\texttt{Pylint} and \texttt{PEP8} to perform the static analysis and code style
checking. They will be run using the \texttt{setup.py} script and so there
configuration is in \texttt{setup.cfg}.

Run the two commands:

\begin{lstlisting}
 python setup.py lint
 python setup.py pep8
\end{lstlisting}

You may, I think, get a lot of errors, warnings, got and fix them.
However, putting an empty docstring to get rid of the message is evil, it is
your code documentation!

\begin{description}
  \item[Note] The tool may return some false-positive.
    In this case it is possible do disable the error message.
    Refer to the documentation when needed:
    \url{http://docs.pylint.org/message-control}
\end{description}


\subsection{All tests in one command}

\textbf{TODO}
tox

\textbf{TODO}



\subsection{Mocking in tests}

\textbf{TODO}
Advanced!! So I will mainly copy paste code
Only do if finished everything else!

Testing 'main' with sys.argv and printf/sys.stdout mocking.
\textbf{TODO}


\begin{description}
    \item[mock] \url{http://www.voidspace.org.uk/python/mock/index.html}
\end{description}

When testing, it is useful to replace some part of your application to give it
a special behaviour, like raising an exception, or to prevent its side effect,
like connection to an external service. It is also easier to be able to know how
an object has been used or a function been called.

In this section you will see \texttt{mock} to test the \texttt{main} function
and verify the printed output.

\texttt{mock} class provides mainly two important things:
\begin{itemize}
    \item \texttt{Mock} class which is an object whose behaviour can be
        configured and that records all action on it.
    \item \texttt{patch} function that dynamically replaces one
        function/method/object with a Mock object.
\end{itemize}





\section{Continuous Integration Part}
\subsection{Validate on CI}

At this point you have a your python project packaged with setup.py and tests
running managed by tox. This means that running your tests only need to run~:

\begin{lstlisting}
tox
\end{lstlisting}

\subsection{Running your first test on CI}

\begin{itemize}
\item Create your job with \texttt{New Item} button on the left menu.
\item For Python create a \texttt{Freestyle project} and put a name without spaces, it always
brings errors in scripts to have path with spaces.
\item Then go to \texttt{Configure}.
\end{itemize}

\subsubsection{Git configuration}

\begin{itemize}
\item Go to \texttt{Source Code Management} and choose \texttt{Git}
\item Put the anonymous git url of the repository \texttt{ADD\_URL\_HERE} and select your branch name \texttt{*/branch\_name}.
\end{itemize}

\subsubsection{Build Step}

\begin{itemize}
\item Add build step~: \texttt{Execute Shell} and execute~:
\begin{lstlisting}
cd python/
tox
\end{lstlisting}
\item Save the configuration.
\end{itemize}

\subsubsection{Running test}

What is the result ?

See \texttt{Console Output} to see the script execution.

\subsection{Fixing the errors the Python way}

As seen, \texttt{tox} is not installed on the build machine. It can either be installed
manually or as a step of the integration process. The last solution is more in
the process of 'integration' but sometimes you don't have the choice.

\begin{itemize}
\item Remove the build step and replace it with \texttt{Virtualenv Builder}.
This puts the code execution in a separated python environment for the build.
\item Now as first step, install your `tox` dependency~:
\begin{lstlisting}
pip install --quiet --upgrade tox
cd python
tox
\end{lstlisting}
\item Save and build, it should be a successful build.
\end{itemize}

See the build output, you can see tests/coverage/pylint/pep8 text results.


\subsection{Adding Build feedback}

A big value of Jenkins is the ability to nicely present your tests results.

The tools used to run tests and code quality where selected because they have output files compatible with Jenkins plugins.

\begin{description}
\item[Note~:]
This selection may look restrictive, but it also means that the tools are indeed used by many developers and that it is
not only a one man written test script.
\end{description}

\begin{itemize}
\item \texttt{nosetests} outputs as a JUnit compatible XML~: \texttt{nosetests.xml}
\item \texttt{nose-xcover} outputs coverage compatible with cobertura~: \texttt{coverage.xml}
\item \texttt{pylint} and \texttt{pep8} output is recognized by 'warnings' and 'violations' plugins.
\end{itemize}

These output parsing is managed in \texttt{Add post-build action}.
%% Maybe print the real plugins names here

\subsection{Add tests results feedback}

\begin{description}
\item[Step \texttt{Publish JUnit test result report}] \hfill \\
\begin{itemize}
\item Test report xml~: `**/*tests.xml` to scan for all files ending with 'tests.xml'
\end{itemize}
\end{description}

\subsubsection{Add coverage feedback}

\begin{description}
\item[Step \texttt{Publish Cobertura Coverage Report}] \hfill \\
  \begin{itemize}
  \item Cobertura xml report pattern~:  \texttt{**/coverage.xml} to scan for all  \texttt{coverage.xml} files.
  \end{itemize}
\end{description}

As source files are not based at root directory Cobertura fails to locate source
files.

A solution is to create a symlink to the source directory~:
\begin{itemize}
  \item Add a build step \texttt{Execute shell} with~:
\begin{lstlisting}
# Hack to help cobertura find source files
ln  -nfs python/tp_ci_sed  tp_ci_sed
\end{lstlisting}
\end{itemize}

\subsubsection{Add code quality output}

\begin{description}
\item[Step \texttt{Scan for compiler warnings}] \hfill \\
  \begin{itemize}
  \item Scan console log add two parsers, one for \texttt{pylint} and another for \texttt{pep8}.
  \item In advanced configuration, select 'Resolve relative paths', either the plugin doesn't find the source files as they are not in the root folder.
  \end{itemize}
\end{description}


\subsubsection{Code review by ChuckNorris}

\begin{description}
\item[Step \texttt{Activate Chuck Norris}] \hfill \\
It displays you Chuck Norris facts and a picture of Chuck adapted to your build result (seems like the picture is not displayed why ?)
\end{description}


Do not forget to save configuration.


\subsection{Analyze build output}

\begin{itemize}
\item Build the project two times to get a nice displayed output. Plugins need
multiple builds to create graphs.
\end{itemize}


\subsection{Coverage Report}

\begin{itemize}
\item Click on Coverage Report, you can then see per file coverage output.
\end{itemize}


\subsection{Pylint/PEP8}

\begin{itemize}
\item Click on Pylint/PEP8 reports and see the errors in the source files.
\end{itemize}



\subsection{Further steps}

%% TODO

Automatically run the build~:
\begin{itemize}
\item  Never~: you only run it manually (not recommended)
\item Periodically~: Every night at 3AM may be enough if your code moves slowly
\item At each commit~: with repository polling/ with git hook (see how...)
\end{itemize}

Send mails on build failure~:
\begin{itemize}
\item  Howto do that ?
\end{itemize}


\subsection{Improvements}

\begin{itemize}
\item Try fixing all your code to get perfect results outputs;*
\item Use tox to run tests on python3 also and make your code compatible with.
\end{itemize}

%%\lipsum[1]

%%Listing \ref{Sphere} shows a Java program.
%%\javascript{Sphere}{Sample Java program with Highlighting}

%%Another program example for Python
%%Listing \ref{Python_example} shows a Python program.
%%\pythonscript{Python_example}{Sample Python program with highlighting}


\end{homeworkProblem}



%----------------------------------------------------------------------------------------
%   C++
%----------------------------------------------------------------------------------------
%"${)

\begin{homeworkProblem}[C++ Exercice]
\section{Local Test Part}

\subsection{Preamble}

To perform this \texttt{C++} exercice, we rely on three main development tools~:

\begin{itemize}
\item A \texttt{C++} compiler, for example \texttt{GNU C++} or \texttt{clang}.
\item A build process manager~: \texttt{CMake} 
\item A testing framework~: \texttt{cppunit}.
\end{itemize}

On Linux, BSD, MACOS X systems, suitables versions may simply be installed with the package manager (\texttt{yum, apt, etc}).

For example on Fedora systems, one may use the command~:
\begin{itemize}
\item \texttt{yum install cmake cppunit gcc-c++}
\end{itemize}
and on recent Debian or Ubuntu systems~:
\begin{itemize}
\item \texttt{apt-get install cmake cppunit gcc-c++}
\end{itemize}


\subsection{Setup}

\subsubsection{Clone the git repository from INRIA forge and create your own branch}
\begin{lstlisting}
$ git clone git+ssh://<yourloginhere>@scm.gforge.inria.fr/gitroot/tpcisedra/tpcisedra.git 
$ cd tpcisedra/cxx
$ git checkout -b <yournamehere>
\end{lstlisting}

A minimal \texttt{CMake} project is present under the file tree~:\\
{\centering\small
            \begin{minipage}[t]{0.3\linewidth}
\dirtree{%
  .1 tpcisedra/c++.
  .2 src.
  .3 CMakeLists.txt.
  .3 cmake.
  .4 TP.cmake.
  .3 Sphere.hpp.
  .3 Sphere.cpp.
  .3 bench.cpp.
  .3 tests.
  .4 CMakeLists.txt.
  .4 TestTP.hpp.
  .4 TestTP.cpp.
  .4 TestMain.cpp.
}
\end{minipage}
}


This \texttt{CMake} project provides the framework needed to build and test a
dynamic shared and versioned ``TP'' \footnote{``TP'' for ``Travaux Pratiques''
  in french} library. The \texttt{CMake} configuration is specified in two
\texttt{CMakeLists.txt} files~:
\begin{itemize}
\item one under the \texttt{src} directory : the main \texttt{CMakeLists.txt}
\item one under the \texttt{tests} directory.
\end{itemize}

The API provided by this library is at this level composed by a single \texttt{Sphere} class. The \texttt{Sphere} class offers an object constructor with the \texttt{radius} as parameter and a \texttt{volume} method.

A benchmark program named \texttt{bench.cpp} is also built and linked with the
library. Although the computation is very simple, this benchmark program may
be used to compare the influence of some compiler optimization flags.

\subsubsection{Check that you can build the project and run the test}

On a Unix system~:
\begin{itemize}
\item create a build directory, 
\item create the build environment with \texttt{CMake},
\item build the project,
\item run the test
\end{itemize}


\begin{lstlisting}
$ mkdir build
$ cd build
$ cmake ../cxx
$ make
$ make test
\end{lstlisting}

\subsubsection{Run the benchmark}

\texttt{CMake} provides pre-defined build configuration that may be choosen
with the \texttt{CMAKE\_BUILD\_TYPE} variable. Among them we are going to
consider~:

\begin{itemize}
\item the \texttt{Debug} build type which sets the debug flags (\texttt{-g} with gcc) 
\item the \texttt{Release} build type which sets some optimization flags (\texttt{-O3 -DNDEBUG} with gcc)
\end{itemize} 

Once a directory has been given as argument to \texttt{CMake} it remains in a
cache, the \texttt{CMakeCache.txt} file in your build directory. This cache
file is a text file and may be edited by hand.

So for next calls to \texttt{CMake}, we can use the dot directory as argument~:

\begin{lstlisting}
$ cmake .
\end{lstlisting}

\texttt{CMake} variables may be set on the command line with \texttt{-D}
arguments~: \texttt{cmake . -D<VARIABLE\_NAME>=<VALUE>}. The value remains in
the cache file, so when a variable has been modified once with a call to cmake, it
is not necessary to define its value anymore on the command line.

Let's configure our build to a debug build~:
\begin{lstlisting}
$ cmake . -DCMAKE_BUILD_TYPE=Debug
$ make
$ ./bench
\end{lstlisting}

For an optimized build, we do~:
\begin{lstlisting}
$ cmake . -DCMAKE_BUILD_TYPE=Release
$ make
$ ./bench
\end{lstlisting}

Over this very simple computation, the benchmark difference between Debug and
Release is not dramatic.

With \texttt{gcc} compiler, we can go beyond \texttt{-O3} optimization flag with the
\texttt{fast-math} option, which implies \texttt{-funsafe-math-optimizations}
and may break some of the requirements of \texttt{IEEE} and \texttt{ANSI}
standards.

To pass a specific argument to the \texttt{c++} compiler we use the variable
\texttt{CMAKE\_CXX\_FLAGS}. The arguments passed on the command line to this
variable are added to the other compiler arguments. In doubt with the
generated specification, one can use the argument \texttt{VERBOSE=1} to make,
in order to see the flags passed to the compiler.

\begin{lstlisting}
$ cmake . -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_FLAGS=-ffast-math
$ make VERBOSE=1
$ ./bench
\end{lstlisting}

Now, let's keep this configuration in our build directory.

\subsubsection{Jenkins setup}

Log into the project's Jenkins instance~:

\begin{enumerate}
\item Connect to the INRIA Continuous Integration web portal~: https://ci.inria.fr/.

\item Log in and click ``Dashboard''in the top menu
\item You should have been added to project ``TPCISedRa'', click on the ``Jenkins'' button.
You may be prompted to log into jenkins, use the same login/passwd as for the ci portal.
\end{enumerate}

Running your first test on CI~:
\begin{itemize}
\item From our Jenkins dashboard page (https://ci.inria.fr/tpcisedra/), click ``New Item'' in the menu on the left
\item Provide a name for this new item (avoid spaces since it is likely to lead to errors) and select ``Freestyle project''
\end{itemize}


Git configuration~:
\begin{itemize}
\item In the new item's configuration page (which you will be redirected to after clicking ``OK''), choose \texttt{Git} as your Source Code Manager
\item Copy the \emph{anonymous} URL to your personal repository into the appropriate field~:

\begin{lstlisting}
https://scm.gforge.inria.fr/anonscm/git/tpcisedra/users/<your login>.git
\end{lstlisting}
\end{itemize}

FIX~: add build trigger.


\subsubsection{Exercice 1}

Add a new build step~: ``Execute shell'', where you inform \texttt{Jenkins} how to build and test the project.

\begin{itemize}
\item You have to choose the \texttt{Debug} configuration for this build, this will be needed for coverage as we will see later.\\
In the shell working directory (the result of the command \texttt{/bin/pwd} in
this shell) \texttt{Jenkins} has cloned your source directory.
\item Then save the project and verify the configuration with a click on ``Build
Now'' in the menu on the left.
\item In the \texttt{Build History} on the left, click on the last build (hopefully \#1), then select \texttt{Console Output}.\\
You can also check the \texttt{Test Result}.
\end{itemize}

\subsubsection{Exercice 2}

Edit the implementation of the \texttt{Sphere} class~:
\texttt{tpcisedra/c++/src/Sphere.cpp} and have a look at the code of the method \texttt{Sphere::volume()}.

\begin{lstlisting}
double Sphere::volume() const
{
  return 4 * M_PI * pow (this->_radius, 3.) / 3.;
}
\end{lstlisting}

This is the method which is tested in the unique test of the library, and the test is implemented in the file~:

\texttt{tpcisedra/c++/src/tests/testTP.cpp}

Let's imagine we want to improve the efficiency of the \texttt{volume()}
method by pre-computing the value \verb?4 * Math.PI / 3?


TODO~:
\begin{itemize}
\item Extract this value into a class data member.
\item Run the benchmark. This may shows only a very, very minimal improvement!
\item Run the test.
\end{itemize}

The test may still be successfull (this may depends on your hardware and compiler).

Let's assume it is successfull and commit your modifications.

\begin{lstlisting}
$ git commit -m "precomputation of 4pi/3"
$ git push -a
\end{lstlisting}

The test should now fail on Jenkins.

Here is the output you can see on Jenkins console~:
\begin{lstlisting}
+ make test
Running tests...
Test project /builds/workspace/mb-cxx/build
    Start 1: TestVolume
1/1 Test #1: TestVolume .......................***Failed    0.00 sec

0% tests passed, 1 tests failed out of 1

Total Test time (real) =   0.00 sec

The following tests FAILED:
	  1 - TestVolume (Failed)
\end{lstlisting}


\subsubsection{More on exercice 2}

The \texttt{-funsafe-math-optimizations} implied by \texttt{-ffast-math}
allows for reordering of floating points operations and this may lead to
differents results.

The direct check of equality of floating point numbers with the \texttt{==}
operator should be avoided, we first add a warning (only if understood by the
compiler) in order not to reproduce this kind of error.

\textbf{Note}~:
\begin{itemize}
\item Since version $4.6$. \texttt{gcc} provides this warning \texttt{-Wfloat-equal}. 
\item With portability in mind, before adding the flag to the compiler command, we need to check that the compiler accepts it.
\end{itemize}

With \texttt{CMake}, there is no builtin function for this operation, but that
can be achieved with a simple macro~:

\begin{lstlisting}
include(TestCXXAcceptsFlag)
macro(add_cxx_compiler_flag _flag)
  string(REPLACE "-" "_" _flag_var ${_flag})
  check_cxx_accepts_flag("${_flag}" CXX_COMPILER_${_flag_var}_OK)
  if(CXX_COMPILER_${_flag_var}_OK)
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} ${_flag}")
  endif()
endmacro()
\end{lstlisting}

This macro is provided in the TP.cmake module under \texttt{cmake} directory.

To load this TP module, one have to set the \texttt{CMake module path} to this directory~:
\begin{lstlisting}
set(CMAKE_MODULE_PATH ${CMAKE_CURRENT_SOURCE_DIR}/cmake)
\end{lstlisting}

%$

And then load the module~:

\begin{lstlisting}
include(TP)
\end{lstlisting}

This should be done before using the macro.

On Jenkins side, compiler warnings can be checked in the \texttt{Post build Actions} step of your build project. 

TODO~:
\begin{itemize}
\item In the \texttt{CMake} configuration file, main \texttt{CMakeLists.txt}, include the TP module.
\item With the provided \texttt{CMake} macro, add the compiler warning to the \texttt{CMake} configuration.
\item Verify that the warning is printed during compilation.
\item In Jenkins, add the scan for compiler warnings in the \texttt{Post build Action} of your project
\item Commit the code in order to check the parsing done by Jenkins.
\item Modify the appropiate test in \texttt{TestTP.cpp} so small rounding
  differences do not cause errors, \texttt{cppunit} provides a macro for this~: 
  \texttt{CPPUNIT\_ASSERT\_DOUBLES\_EQUAL(expected, actual, delta)}.
\item Once it is OK and the warning has gone, commit.
\end{itemize}

%$



%--------------------------------------
\subsection{Test Coverage}

At this stage, all our tests pass. But what does that mean regarding our application ?

Not much, you may say, but can you quantify it and will you be able to tell on a real project ?

This is when \textbf{test coverage} becomes handy.

\subsubsection{Installation}

Coverage with \texttt{gcov} needs the \texttt{gcc} compiler and the
\texttt{-fprofile-arcs} and \texttt{-ftest-coverage} options.  \texttt{gcov}
generates raw output. We are going to use the lcov utility for the
post-processing and the generation of html pages and the gcovr utility in
order to present parsable results to \texttt{Jenkins}.

A \texttt{CMake} function \texttt{add\_test\_with\_coverage} is provided in the
\texttt{TP} module to simplify the whole setup.

This function when used in place of the standard \texttt{CMake} function
\texttt{add\_test} function provides coverage support through a new
\texttt{make} target (You can see all \texttt{make} targets with the help
target~: \texttt{make help})
%$

\subsubsection{Exercice 3}

TODO~:
\begin{itemize}
\item Install coverage for the test \texttt{TestVolume}. You need to set the coveraged flags for the build of the library and the test with the \texttt{add\_cxx\_compiler\_flags}.
\item With a Web browser, open the file \texttt{index.html} under \texttt{TestTP\_\_testVolume} directory.
\item On the \texttt{Jenkins} side, in \texttt{Post-Build Actions} add \texttt{Publish Cobertura Report} with the cobertura xml report pattern set to \texttt{<to be fixed>.xml}
\item Commit
\end{itemize}


\subsubsection{Add some new class to our project}

Let's add a new class \texttt{Alphabet} and its test class \texttt{AlphabetTest} to our project~:
\begin{lstlisting}
$ git merge alpha-cxx
\end{lstlisting}

%$

\subsubsection{Exercice 4}
\begin{itemize}
\item Generate and visualize the corresponding coverage report
\item Make what changes are necessary to achieve 100\% test coverage
\end{itemize}

%--------------------------------------
\subsection{Stylecheck}

\subsubsection{Run a style checker}

Let's try and run a style checker~:
\begin{lstlisting}
$ pwd
yourpath/tpcisedra/java
$ mvn checkstyle:checkstyle
\end{lstlisting}
We get plenty of errors with the default style \verb?sun_checks.xml?.

Our coding style is close to Google style than it is to Sun style.

\subsubsection{Run Google style checker}

Try running with Google checks (provided by the plugin)
\begin{lstlisting}
$ pwd
yourpath/tpcisedra/java
$ mvn checkstyle:checkstyle -Dcheckstyle.config.location=google_checks.xml
\end{lstlisting}
NOTE~: this can also be achieved by adding the following lines to your pom.xml~:
\begin{lstlisting}
  <properties>
    <checkstyle.config.location>checkstyle-test.xml</checkstyle.config.location>
  </properties>
\end{lstlisting}

It's getting better but we might want to make a few changes to this default behaviour.

\subsubsection{Exercice 5}

\begin{itemize}
\item Retrieve a local copy of google checks
\begin{lstlisting}
$ wget https://raw.githubusercontent.com/checkstyle/checkstyle/
     18f6ebbcad23e88e3ae30fc79be464b8b7772a0d/google_checks.xml
\end{lstlisting}
\item  Modify the file \texttt{google\_checks.xml} so that it accepts single character parameter names
\item You may also consider removing trailing underscores from data members or amending \texttt{checkstyle.xml}.
\end{itemize}

\subsubsection{[Optional] Integrate checkstyle to your reporting local website}

Add the following to the file \texttt{pom.xml}
\begin{lstlisting}
  <reporting>
    <plugins>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-checkstyle-plugin</artifactId>
        <version>2.16</version>
      </plugin>
    </plugins>
  </reporting>
\end{lstlisting}

The check style report is now included in the build lifecycle (``site'' phase).

\subsubsection{Exercice 5bis}

\begin {itemize}
\item To generate the report~:
\begin{lstlisting}
$ pwd
yourpath/tpcisedra/java
$ mvn site
\end{lstlisting}
\item Use your favorite WEB browser (firefox, chrome, iceweasel, \...) to visualize the generated report~:
\begin{lstlisting}
$ firefox target/site/project-reports.html &
\end{lstlisting}
\end{itemize}

The tools we used to run tests and code quality checks have been selected based on the availability of the corresponding Jenkins plugins.

\subsubsection{Add coverage report}
\begin{itemize}
\item Go back to your item's configuration page (use the menu on the left)
\item Replace your build's ``Goals and options'' with \texttt{cobertura:cobertura -Dcobertura.report.format=xml}
\item Click on ``Add post-build action'' and select ``Publish Cobertura Coverage Report'' from the drop-down menu, your ``Cobertura xml report pattern'' is \texttt{**/target/site/cobertura/coverage.xml} (it is the example provided below the field)
\item Save and Run the test
\item Check the output~: in the ``Build History'' on the left, click on the last build, you should have a new entry named ``Coverage Report'', have a look at it
\end{itemize}

\subsubsection{Add checkstyle report}
\begin{itemize}
\item Go back to your item's configuration page and add \\
\texttt{checkstyle:checkstyle -Dcheckstyle.config.location=google\_checks.xml} to your build's ``Goals and options''
\item Check the ``Publish Checkstyle analysis results'' box in ``Build Settings''
\item Save and Run the test
\item Check the output~: in the ``Build History'' on the left, click on the last build, you should have a new entry named ``Checkstyle Warnings'', have a look at it
\end{itemize}


%%Extract from C++ program
%%\begin{lstlisting}[name=Function Test, frame=trBL]
%%#include <iostream>
%%#include <basetsd.h>
%%#include <iomanip>
%%#include <cstdlib>
%%using namespace std;
%%
%%union FloatNum //Here the tag name (FloatNum) is redundant.
%% {
%%   float fx;//4 bytes variable
%%   long  lx;//4 bytes variable
%% }fn;
%%
%%union DoubleNum
%% {
%%   double dx;  //8 bytes variable
%%   LONG64 lx;  //8 bytes variable
%% }dn;
%%
%%union LongDoubleNum
%% {
%%   long double dx;  //12 bytes variable
%%   long  lx[3]; // 3 * 4 bytes variable
%% }ldn;
%%
%%int main()
%%{
%%    fn.fx = -118.6253433; //variable assignment declaration statement
%%   //show size of float
%%    cout << "\nsize of float = " << dec << sizeof(fn.fx) << endl;
%%    cout << setprecision(10) << fn.fx << " = 0x" << hex << fn.lx << endl;
%%
%%    dn.dx =  112.6255678;  //assign value to a variable
%%    //show size of double
%%    cout << "\nsize of double = " << dec << sizeof(dn.dx) << endl;
%%    cout << dn.dx <<"  = 0x" << hex << dn.lx << endl;
%%
%%    ldn.dx = -12.61256125;  //assign value to a variable
%%    //show size of long double
%%    cout << "\nsize of long double = " << dec << sizeof(ldn.dx) << endl;
%%    cout << setprecision(10) << ldn.dx << " = 0x"
%%         <<  hex << ldn.lx[2] << ldn.lx[1] << ldn.lx[0] << endl;
%%    return 0;
%%}
%%\end{lstlisting}


%\problemAnswer{

%Answer
%\begin{center}
%\includegraphics[width=0.75\columnwidth]{example_figure} % Example image
%\end{center}

%\lipsum[3-5]
%}
\end{homeworkProblem}

%----------------------------------------------------------------------------------------

\end{document}
